{% extends "base.html" %}

{% block title %}iDiary| Home{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        <div class="container">
            <h2>{{ user.username }}'s Diary</h2>
        
            <!-- New Post Form -->
            {% if user.is_authenticated %}
            <form method="post" action="{% url 'index' %}" class="mt-3">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="content" rows="3" placeholder="Write a new diary entry" class="form-control"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Post</button>
            </form>
            {% endif %}
        </div>

        <button class="btn btn-primary" id="show-favourized-button">Toggle Favourized Entries</button>
        
        <!-- Display Posts -->
        <div class="mt-4">
            {% for entry in page_obj %}
            <div class="card mb-3 {% if entry.id in favourized_entries %}favourized{% endif %}">
                <div class="card-body">
                    <p class="card-text" id="entry-content-{{ entry.id }}">{{ entry.content }}</p>
                    <p class="card-text">
                        <small class="text-muted">Posted on {{ entry.created_at }}
                            and last edited on {{ entry.updated_at}}.
                        </small>
                    </p>

                    <!-- Comment section -->
                    <div id="comment-section-{{ entry.id }}">
                        <h6>Comments:</h6>
                        <ol>
                            {% for comment in entry.comments.all %}
                            <li class="comment">
                                {{ comment.content }}
                            </li>
                            {% endfor %}
                        </ol>
                    </div>

                    <!-- Comment Button-->
                    {% if entry.user == request.user %}
                <!-- Comment Form -->
                <button class="btn btn-primary comment-button" data-entry-id="{{ entry.id }}">Comment</button>
                <div class="modal" id="comment-modal-{{ entry.id }}" style="display: none;">
                    <form method="post" data-entry-id="{{ entry.id }}" class="comment-form">
                        {% csrf_token %}
                        <input type="hidden" name="entry_id" value="{{ entry.id }}">
                        <div class="form-group">
                            <textarea name="comment_content" rows="3" class="form-control" placeholder="Add a comment"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success save-comment-button">Submit Comment</button>
                    </form>
                </div>
                    {% endif %}
        
                    <!-- Favourize Post Button -->
                    <button class="btn btn-primary btn-favourize" data-entry-id="{{ entry.id }}">
                        <span id="favourize-button-{{ entry.id }}"> <!-- Correct the ID attribute -->
                            {% if request.user in entry.favourized.all %}
                                Unfavourize
                            {% else %}
                                Favourize
                            {% endif %}
                        </span>
                    </button>                    
        
                    <!-- Edit Post Button -->
                    {% if entry.user == request.user %}
                    <button class="btn btn-warning edit-button" data-entry-id="{{ entry.id }}">Edit</button>
                    <div id="edit-form-{{ entry.id }}" style="display: none;">
                        <!-- Edit Form for the post -->
                        <textarea id="edit-content-{{ entry.id }}" class="form-control" rows="3">{{ entry.content }}</textarea>
                        <button class="btn btn-success save-button" data-entry-id="{{ entry.id }}">Save</button>
                    </div>
                    {% endif %}

                    <!-- Delete Button -->
                    {% if entry.user == request.user %}
                    <form method="post" action="{% url 'delete_entry' entry.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger delete-button">Delete</button>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination Links -->
        <div class="pagination mt-4">
            <span class="step-links">
                {% if page_obj.has_previous %}
                <a href="?page=1">&laquo; first</a>
                <a href="?page={{ page_obj.previous_page_number }}">previous</a>
                {% endif %}
                <span class="current-page">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
                {% endif %}
            </span>
        </div>
    {% else %}
        <div class="container">
            <h2>Welcome to iDiary! Start writing your Diary today.</h2>
            <p>Let's begin with your first <a href="{% url 'register' %}">Entry</a>.</p>
        </div>
    {% endif %}
</body>
{% endblock %}